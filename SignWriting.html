<!DOCTYPE HTML>
<html>	
<head>
<link rel="stylesheet" href="styleSignWriting.css">
<script src="scriptsSignWriting.js"></script>
</head>
<body>
	<div>
		<canvas id="canvas" width="canvasWidthX" height="canvasHeightX"></canvas>
		<p id="debug"></p>
	</div>
	<script>
	var smokeOld = 0;
	var smokeHasToggled = false;
	var canvas = document.getElementById('canvas');
	var context = canvas.getContext('2d');
	var oldPlaneTopPixels;
	var oldPlaneLeftPixels;
	var planeTopPixels;
	var planeLeftPixels;
	function update(timestamp)
	{
		const mapNorth = mapNorthX; 
		const mapEast = mapEastX;
		const mapSouth = mapSouthX;
		const mapWest = mapWestX;
		const mapHeight = mapHeightX;
		const messageLength = messageLengthX;
		const magVar = magVarX;
		const padding = 20
	
		var currentGateNo = VarGet("S:currentGateNo" ,"NUMBER");
		var planeHeadingT = VarGet("A:PLANE HEADING DEGREES MAGNETIC" ,"Radians") * 180 / Math.PI + magVar;
		if (planeHeadingT > 360)
			planeHeadingT = planeHeadingT - 360;
		if (planeHeadingT < 0)
			planeHeadingT = planeHeadingT + 360;
		var planeLonDeg = VarGet("A:PLANE LONGITUDE" ,"Radians") * 180 / Math.PI; // x
		var planeLatDeg = VarGet("A:PLANE LATITUDE" ,"Radians") * 180 / Math.PI;  // y
		var messageHeight = mapHeight - 2 * padding;
		var messageWidth = 0.75 * messageHeight * messageLength;
		planeTopPixels = Math.round((planeLatDeg - mapNorth) / (mapSouth - mapNorth) * messageHeight);
		planeLeftPixels = Math.round((planeLonDeg - mapWest) / (mapEast - mapWest) * messageWidth);
		var smokeOn = VarGet("S:smokeOn", "NUMBER"); 
		if (smokeOn != smokeOld)
			smokeHasToggled = true;
		smokeOld = smokeOn;
		if (smokeHasToggled && smokeOn == 1) {
			oldPlaneTopPixels = planeTopPixels;
			oldPlaneLeftPixels = planeLeftPixels;
			context.beginPath();
			if ((planeHeadingT > 345 || planeHeadingT < 15) || (planeHeadingT > 75 && planeHeadingT < 105) || (planeHeadingT > 165 && planeHeadingT < 195) || (planeHeadingT > 255 && planeHeadingT < 285))
				context.lineWidth = "10";
			else
				context.lineWidth = "7";
			document.getElementById('debug').innerHTML = "currentGateNo = " + currentGateNo;
			context.strokeStyle = "red"; 
			context.lineCap = "round";
			smokeHasToggled = false;
		}
		if (smokeOn == 1) {
			document.getElementById('debug').innerHTML = "currentGateNo = " + currentGateNo;
			context.moveTo(oldPlaneLeftPixels + padding, oldPlaneTopPixels + padding);
			context.lineTo(planeLeftPixels + padding, planeTopPixels + padding);
			context.stroke(); // Draw it
		}
		oldPlaneTopPixels = planeTopPixels;
		oldPlaneLeftPixels = planeLeftPixels;
		window.requestAnimationFrame(update);
	}
	window.requestAnimationFrame(update);
	</script>
</body>
</html>